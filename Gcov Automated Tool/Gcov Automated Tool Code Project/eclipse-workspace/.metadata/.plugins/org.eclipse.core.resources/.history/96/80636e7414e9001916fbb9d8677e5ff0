package gcov.ui;

import java.awt.EventQueue;
import javax.swing.DefaultListModel;
import javax.swing.DefaultListSelectionModel;
import javax.swing.JButton;
import javax.swing.JFileChooser;
import javax.swing.JFrame;
import javax.swing.JList;
import javax.swing.JPanel;
import javax.swing.border.EmptyBorder;
import javax.swing.JScrollPane;
import java.awt.event.ActionListener;
import java.io.File;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.awt.event.ActionEvent;
import javax.swing.border.TitledBorder;
import gcov.beans.GcovFile;
import gcov.utils.CmdExecutor;
import gcov.utils.Filewalker;
import javax.swing.JMenuBar;
import javax.swing.JMenu;
import javax.swing.JMenuItem;
import javax.swing.JOptionPane;
import javax.swing.JLabel;
import javax.swing.UIManager;
import java.awt.Color;
import javax.swing.JTextPane;
import java.awt.Font;
import javax.swing.ImageIcon;
import javax.swing.JTextField;
import javax.swing.SwingConstants;
import java.awt.Toolkit;
import java.awt.SystemColor;

@SuppressWarnings("serial")
public class GcovAutomatedApp extends JFrame {

	private static String DEBUG_DIR_PATH = "\\CortexM3\\ARM_GCC_541\\Debug";
	private static String MAIN_FUNC_PATH = "\\main.c";
	private File projectFolder;
	private JPanel contentPane;
	private JList<String> leftList;
	private JList<String> rightList;
	private JButton btnLoadProject;
	private JButton btnMove;
	private JScrollPane rightScrollPane;
	private List<File> SourceFiles;
	private JPanel panelSourceFile;
	private JMenuBar menuBar;
	private JMenu mnFile;
	private JMenu mnHelp;
	private JMenuItem mntmExit;
	private JLabel lblSelectedFiles;
	private JFileChooser chooser;
	private JTextPane textPanePath;
	private JLabel lblComPort;
	private JLabel lblBaud;
	private JTextField textFieldComPort;
	private JTextField textFieldBaud;
	private JButton btnExecute;
	private JMenuItem mntmAbout;
	private JButton btnSelectAll;
	private JButton btnCreateGcna;
	private List<GcovFile> gcovFilesList;
	private JPanel panel;
	private JList<String> listGcda;
	private List<String> allSelectedFilesNames;
	private List<File> allSelectedGcnoFiles;
	private List<File> allSelectedGcnaFiles;
	private List<File> allGcnaFiles;

	/**
	 * Launch the application.
	 */
	public static void main(String[] args) {
		EventQueue.invokeLater(new Runnable() {
			public void run() {
				try {
					GcovAutomatedApp frame = new GcovAutomatedApp();
					frame.setVisible(true);
				} catch (Exception e) {
					e.printStackTrace();
				}
			}
		});
	}

	/**
	 * Create the frame.
	 */
	public GcovAutomatedApp() {
		setIconImage(Toolkit.getDefaultToolkit().getImage(GcovAutomatedApp.class.getResource("/gear.png")));
		setTitle("Gcov Automated Tool");
		setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		setBounds(100, 100, 680, 587);
		contentPane = new JPanel();
		contentPane.setBorder(new EmptyBorder(5, 5, 5, 5));
		setLocationRelativeTo(null);

		menuBar = new JMenuBar();
		setJMenuBar(menuBar);

		mnFile = new JMenu("File");
		menuBar.add(mnFile);

		mntmExit = new JMenuItem("Exit");
		mntmExit.setIcon(new ImageIcon(
				GcovAutomatedApp.class.getResource("/javax/swing/plaf/metal/icons/ocean/minimize-pressed.gif")));
		mntmExit.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent e) {
				System.exit(JFrame.EXIT_ON_CLOSE);
			}
		});
		mnFile.add(mntmExit);

		mnHelp = new JMenu("Help");
		menuBar.add(mnHelp);

		mntmAbout = new JMenuItem("About..");
		mntmAbout.setIcon(
				new ImageIcon(GcovAutomatedApp.class.getResource("/javax/swing/plaf/metal/icons/ocean/menu.gif")));
		mnHelp.add(mntmAbout);
		setContentPane(contentPane);
		contentPane.setLayout(null);

		panelSourceFile = new JPanel();
		panelSourceFile.setBorder(new TitledBorder(UIManager.getBorder("TitledBorder.border"), "Source Files:",
				TitledBorder.LEADING, TitledBorder.TOP, null, new Color(0, 0, 0)));
		panelSourceFile.setBounds(23, 90, 619, 335);
		contentPane.add(panelSourceFile);
		panelSourceFile.setLayout(null);

		JScrollPane leftScrollPane = new JScrollPane();
		leftScrollPane.setBounds(21, 28, 165, 285);
		panelSourceFile.add(leftScrollPane);

		leftList = new JList<String>();
		leftList.setSelectionModel(new DefaultListSelectionModel() {
			@Override
			public void setSelectionInterval(int index0, int index1) {
				if (super.isSelectedIndex(index0)) {
					super.removeSelectionInterval(index0, index1);
				} else {
					super.addSelectionInterval(index0, index1);
				}
			}
		});
		leftScrollPane.setViewportView(leftList);

		btnSelectAll = new JButton("Select All");
		leftScrollPane.setColumnHeaderView(btnSelectAll);
		btnSelectAll.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent arg0) {
				try {
					List<String> allFiles = new ArrayList<>();

					for (int i = 0; i < leftList.getModel().getSize(); i++) {
						allFiles.add(leftList.getModel().getElementAt(i));
					}
					rightList.setListData(allFiles.toArray(new String[SourceFiles.size()]));

				} catch (Exception e) {
					JOptionPane.showMessageDialog(contentPane, "No project is loaded,\nBrowse for project first.",
							"Loading Error", JOptionPane.ERROR_MESSAGE);
				}
			}
		});

		rightScrollPane = new JScrollPane();
		rightScrollPane.setBounds(253, 51, 165, 262);
		panelSourceFile.add(rightScrollPane);

		rightList = new JList<String>();
		rightScrollPane.setViewportView(rightList);

		lblSelectedFiles = new JLabel("Selected Source Files:");
		lblSelectedFiles.setForeground(new Color(0, 0, 205));
		lblSelectedFiles.setBounds(255, 33, 165, 14);
		panelSourceFile.add(lblSelectedFiles);

		btnMove = new JButton("->");
		btnMove.setBounds(190, 141, 60, 69);
		panelSourceFile.add(btnMove);

		JScrollPane scrollPaneGcda = new JScrollPane();
		scrollPaneGcda.setBounds(436, 52, 163, 260);
		panelSourceFile.add(scrollPaneGcda);

		listGcda = new JList<String>();
		listGcda.setSelectionModel(new DefaultListSelectionModel() {
			@Override
			public void setSelectionInterval(int index0, int index1) {
				if (super.isSelectedIndex(index0)) {
					super.removeSelectionInterval(index0, index1);
				} else {
					super.addSelectionInterval(index0, index1);
				}
			}
		});
		scrollPaneGcda.setViewportView(listGcda);

		JLabel lblGcdaFiles = new JLabel("Selected .gcda Files:");
		lblGcdaFiles.setForeground(new Color(0, 0, 205));
		lblGcdaFiles.setBounds(434, 33, 167, 14);
		panelSourceFile.add(lblGcdaFiles);
		btnMove.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent arg0) {
				try {
					if (leftList.getSelectedValue() != null) {
						rightList.setListData(leftList.getSelectedValuesList().toArray(new String[SourceFiles.size()]));
					}
				} catch (Exception e) {
					JOptionPane.showMessageDialog(contentPane, "No project is loaded,\nBrowse for project first.",
							"Loading Error", JOptionPane.ERROR_MESSAGE);
				}

			}
		});

		btnLoadProject = new JButton("Browse..");
		btnLoadProject.setIcon(new ImageIcon(GcovAutomatedApp.class.getResource("/preview.png")));
		btnLoadProject.setBounds(522, 29, 120, 50);
		contentPane.add(btnLoadProject);

		JLabel lblProject = new JLabel("Project Folder:");
		lblProject.setForeground(new Color(75, 0, 130));
		lblProject.setFont(new Font("Tahoma", Font.BOLD, 11));
		lblProject.setBounds(23, 11, 178, 14);
		contentPane.add(lblProject);

		JScrollPane scrollPane = new JScrollPane();
		scrollPane.setBounds(23, 29, 489, 50);
		contentPane.add(scrollPane);

		textPanePath = new JTextPane();
		textPanePath.setBackground(SystemColor.controlHighlight);
		textPanePath.setEditable(false);
		textPanePath.setFont(new Font("Arial", Font.PLAIN, 12));
		textPanePath.setForeground(new Color(139, 0, 0));
		scrollPane.setViewportView(textPanePath);

		panel = new JPanel();
		panel.setBorder(new TitledBorder(UIManager.getBorder("TitledBorder.border"), "Configuration",
				TitledBorder.LEADING, TitledBorder.TOP, null, new Color(0, 0, 0)));
		panel.setBounds(23, 440, 274, 68);
		contentPane.add(panel);
		panel.setLayout(null);

		lblComPort = new JLabel("COM Port:");
		lblComPort.setBounds(6, 16, 69, 20);
		panel.add(lblComPort);

		lblBaud = new JLabel("Baud: ");
		lblBaud.setBounds(7, 41, 46, 20);
		panel.add(lblBaud);

		textFieldComPort = new JTextField();
		textFieldComPort.setBounds(72, 16, 57, 20);
		panel.add(textFieldComPort);
		textFieldComPort.setText("9");
		textFieldComPort.setHorizontalAlignment(SwingConstants.CENTER);
		textFieldComPort.setColumns(10);

		textFieldBaud = new JTextField();
		textFieldBaud.setBounds(72, 41, 173, 20);
		panel.add(textFieldBaud);
		textFieldBaud.setHorizontalAlignment(SwingConstants.CENTER);
		textFieldBaud.setText("115200");
		textFieldBaud.setColumns(10);

		btnExecute = new JButton("Execute");
		btnExecute.setFont(new Font("Tahoma", Font.BOLD, 13));
		btnExecute.setForeground(new Color(34, 139, 34));
		btnExecute.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent arg0) {
				try {
					int count = 0;
					if (SourceFiles != null && textFieldComPort.getText().chars().allMatch(Character::isDigit)
							&& !textFieldComPort.getText().isEmpty()
							&& textFieldBaud.getText().chars().allMatch(Character::isDigit)
							&& !textFieldBaud.getText().isEmpty() && listGcda.getSelectedValue() != null) {
						fetchGcdaToList();
						initializeGcovFilesList();
						
						for (GcovFile gfile : gcovFilesList) {
							CmdExecutor.createReport(gfile.getSourcePath(), gfile.getGcnoPath(), gfile.getGcnaPath());
							count++;
						}
						JOptionPane.showMessageDialog(contentPane, "Completed: " + count + " gcov files were created",
								"Completed Message", JOptionPane.INFORMATION_MESSAGE);

					} else {
						JOptionPane.showMessageDialog(contentPane,
								"1. Check if project is loaded.\n2. Check if COM port is valid.\n3. Check if Brud is valid.\n",
								"Execute Error", JOptionPane.ERROR_MESSAGE);
					}

				} catch (Exception e) {
					JOptionPane.showMessageDialog(contentPane, "Check if files existed on correct path.\n",
							"Execute Error", JOptionPane.ERROR_MESSAGE);
				}

			}
		});
		btnExecute.setIcon(new ImageIcon(GcovAutomatedApp.class.getResource("/iconfinder.png")));
		btnExecute.setBounds(450, 438, 192, 68);
		contentPane.add(btnExecute);

		btnCreateGcna = new JButton("Create GCNA");
		btnCreateGcna.setIcon(
				new ImageIcon(GcovAutomatedApp.class.getResource("/javax/swing/plaf/metal/icons/ocean/collapsed.gif")));
		btnCreateGcna.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent e) {
				if (SourceFiles != null && textFieldComPort.getText().chars().allMatch(Character::isDigit)
						&& !textFieldComPort.getText().isEmpty()
						&& textFieldBaud.getText().chars().allMatch(Character::isDigit)
						&& !textFieldBaud.getText().isEmpty()) {

					initializePaths();
					CmdExecutor.createGcdaFiles(textFieldComPort.getText(), textFieldBaud.getText());
				} else {
					JOptionPane.showMessageDialog(contentPane,
							"1. Check if project is loaded.\n2. Check if COM port is valid.\n3. Check if Brud is valid.\n",
							"Execute Error", JOptionPane.ERROR_MESSAGE);
				}
			}
		});
		btnCreateGcna.setBounds(307, 438, 133, 68);
		contentPane.add(btnCreateGcna);
		btnLoadProject.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent arg0) {
				try {
					projectFolder = getSourceFolderPath();
					readAllFilesToList(projectFolder.getAbsolutePath() + "//Src");
					fetchNamesToSourceList(leftList, SourceFiles);
					textPanePath.setText(projectFolder.getAbsolutePath());
					textPanePath.setForeground(new Color(139, 0, 0));
				} catch (Exception e) {
				}
			}
		});
	}

	private void fetchNamesToSourceList(JList<String> jlist, List<File> list) {

		List<String> fileNames = new ArrayList<>();

		for (File file : list) {
			fileNames.add(file.getName());
		}

		DefaultListModel<String> dlm = new DefaultListModel<>();

		Collections.sort(fileNames, String.CASE_INSENSITIVE_ORDER);

		for (String entity : fileNames) {
			dlm.addElement(entity.substring(0, entity.length() - 2));
		}
		jlist.setModel(dlm);
	}

	private void readAllFilesToList(String path) {
		SourceFiles = new ArrayList<File>();

		Filewalker.walkForSourceFile(path, SourceFiles);
		SourceFiles.add(new File(projectFolder.getAbsolutePath() + MAIN_FUNC_PATH));
	}

	private File getSourceFolderPath() {

		File path = null;
		String userDir = System.getProperty("user.home");
		chooser = new JFileChooser(userDir + "\\Desktop");

		chooser.setDialogTitle("Browse For Project Folder");
		chooser.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);

		chooser.setAcceptAllFileFilterUsed(false);
		//
		if (chooser.showOpenDialog(this) == JFileChooser.APPROVE_OPTION) {
			path = chooser.getCurrentDirectory();
			path = chooser.getSelectedFile();
		} else {
			System.out.println("No Selection ");
		}
		return path;
	}

	private void initializePaths() {
		allSelectedFilesNames = new ArrayList<>();
		gcovFilesList = new ArrayList<>();
		for (int i = 0; i < rightList.getModel().getSize(); i++) {
			allSelectedFilesNames.add(rightList.getModel().getElementAt(i));
		}

		String debugFolderPath = projectFolder.getAbsolutePath() + DEBUG_DIR_PATH;
		allSelectedGcnoFiles = new ArrayList<>();
		Filewalker.walkForGcnoFile(debugFolderPath, allSelectedGcnoFiles);

		allGcnaFiles = new ArrayList<>();
		Filewalker.walkForGcnaFile(debugFolderPath, allGcnaFiles);
		fetchNamesToGcnaList(listGcda, allGcnaFiles);

	}

	private String getPath(String fileName, List<File> list) {
		String path = "";
		for (File file : list) {
			if (file.getName().contains(fileName)) {
				path = file.getAbsolutePath();
			}
		}
		return path;
	}
	
	private void initializeGcovFilesList() {
		for (File file : SourceFiles) {
			for (String fileName : allSelectedFilesNames) {
				if (file.getName().substring(0, file.getName().length() - 2).equals(fileName)) {
					gcovFilesList.add(new GcovFile(fileName, file.getAbsolutePath(),
							getPath(fileName, allSelectedGcnoFiles), getPath(fileName, allSelectedGcnaFiles)));
				}
			}
		}
	}
	
	private void fetchGcdaToList() {
		
		List<String> allSelectedGcnaFilesString = new ArrayList<>();

		if (listGcda.getSelectedValue() != null) {
			allSelectedGcnaFilesString = listGcda.getSelectedValuesList();
		}
		Collections.sort(allSelectedGcnaFilesString, String.CASE_INSENSITIVE_ORDER);
		
		allSelectedGcnaFiles = new ArrayList<>();
		
		for (File file : allGcnaFiles) {
			for (String fileName : allSelectedGcnaFilesString) {
				if(file.getName().equals(fileName)) {
					allSelectedGcnaFiles.add(file);
				}
			}
		}	
	}
	
	private void fetchNamesToGcnaList(JList<String> jlist, List<File> list) {

		List<String> fileNames = new ArrayList<>();

		for (File file : list) {
			fileNames.add(file.getName());
		}

		DefaultListModel<String> dlm = new DefaultListModel<>();

		Collections.sort(fileNames, String.CASE_INSENSITIVE_ORDER);

		for (String entity : fileNames) {
			dlm.addElement(entity.substring(0, entity.length()));
		}
		jlist.setModel(dlm);
	}

}
